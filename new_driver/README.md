# foc-based-servo
**Рассмотрение различных способов управления [BLDC](https://www.robotdigg.com/product/1000/5008-KV335-or-5010-KV340-brushless-motor) с помощью библиотеки [SimpleFOC](https://docs.simplefoc.com/) и драйвера [SimpleFOC PowerShield](https://github.com/simplefoc/Arduino-SimpleFOC-PowerShield) на ESP32**
## Содержание

- [Содержание](#содержание)
- [Управление по скорости с разомкнутым контуром](#управление-по-скорости-с-разомкнутым-контуром)
- [Управление по скорости с обратной связью](#управление-по-скорости-с-обратной-связью)
- [Управление по положению с обратной связью](#управление-по-положению-с-обратной-связью)
- [Управление моментом в режиме foc_current](#управление-моментом-в-режиме-foc-current)
- [Траекторное управление приводом](#траекторное-управление-приводом)
- [Управление жесткостью привода](#управление-жесткостью-привода)

## Управление по скорости с разомкнутым контуром
В библиотекет SimpleFOC реализовано управление BLDC двигателем с помощью Векторного управления. Для реализации этих алгоритмов необходимо использавать датчик положения, мной был использован датчик [AS5047P](https://www.digikey.com/en/htmldatasheets/production/1819265/0/0/1/as5047p-ts-ek-ab-manual) с обменой данных через ABI интерфейс.
### Соединение с ESP32

| AS5047P Pin | ESP32 Pin | Comment |
|:-----------:|:-----------:|:--------|
| GND | GND | - |
| VDD | 3V | - |
| VDD3V| NC | - |
| MOSI | MOSI | - |
| MISO | MISO | - |
| CLK | SCK | - |
| CSn | 5 | Can be any unused digital pin on the arduino as long as it's configured here `AS5047P as5047p(<ChipSelectPort>);` |

Структурная схема системы и теория управления приведены [здесь](https://docs.simplefoc.com/velocity_openloop).
Также плату необходимо подключить к пинам драйвера:
| Phases | ESP32 Pin | Comment |
|:-----------:|:-----------:|:--------|
| Phase A | 25 | - |
| Phase B | 26 | - |
| Phase C | 27 | - |
| Enable A | 33 | - |

## Управление по скорости с обратной связью

Управление скоростью осуществляется путем добавления ПИД-регулятора скорости в контур управления крутящим моментом. ПИД-регулятор считывает скорость двигателя υ, фильтрует ее до υ_f и устанавливает целевой крутящий момент (напряжение U_q или ток I_q) в контуре управления крутящим моментом таким образом, чтобы он достигал и поддерживал целевую скорость υ_d, установленную пользователем.
Параметры ПИД-регулятора: пропорциональный коэффициент P, интегральный коэффициент I, производный коэффициент усиления D и output_ramp.
* увеличив пропорциональный коэффициент усиления P, ваш контроллер двигателя станет более реактивным, но слишком большое значение сделает его нестабильным. Установка значения 0 отключит пропорциональную часть контроллера.
* То же самое касается и интегрального коэффициента усиления I: чем он выше, тем быстрее будет реакция двигателя на помехи, но слишком большое значение сделает его нестабильным. Это составляющая позволяет избавиться от статической ошибки регулирования. Установка значения 0 отключит встроенную часть контроллера.
*Производную часть контроллера D обычно сложнее всего настроить, эта составляющая уменьшает перерегулирование и уменьшает коллебательность системы.
*Значение output_ramp предназначено для уменьшения максимального изменения значения напряжения, подаваемого на двигатель. Чем выше значение, тем ПИ-регулятор сможет быстрее изменять значение U_q. Чем ниже значение, тем меньше возможное изменение и тем менее отзывчивым становится ваш контроллер. Значение этого параметра установлено в Вольт в секунду В/с или, другими словами, на сколько вольт ваш контроллер может поднять напряжение за одну единицу времени. Кроме того, чтобы сгладить измерение скорости, в библиотеке Simple FOC реализован фильтр нижних частот скорости. Фильтры нижних частот представляют собой стандартную форму сглаживания сигнала и имеют только один параметр — постоянную времени фильтрации T_f.
Чем ниже значение, тем меньше влияние оказывает фильтр. Если вы установите T_f на 0, вы фактически полностью удалите фильтр. Точное значение T_f для конкретной реализации сложно угадать заранее, но в целом диапазон значений T_f будет где-то от 0 до 0,5 секунды. Параметр Voltage_limit предназначен, если по какой-то причине вы хотите ограничить напряжение, которое может быть подано на двигатель.


## Управление по положению с обратной связью

Структурная схема системы управления двигателем приведена [здесь](https://docs.simplefoc.com/angle_loop). Для оптимадьного управления помимо ПИД-регулятора в контуре тока используется ПИД-регулятор в контуре положения, настройка которого также производилась с помощью эмпирического метода Циглера-Никольса. В результате использования магнитного датчика положения удается добиться крайне высокой точности позиционирования. Для точного управления моменом привода далее будут расмотрены способы управления моментом привода с обратной связью по току вместо связи по напряжению.

## Управление моментом в режиме foc_current

Этот режим управления крутящим моментом позволяет полностью контролировать крутящий момент двигателя BLDC, и для этого требуется измерение тока. Пользователь устанавливает целевой ток I_q для алгоритма FOC, который рассчитывает необходимые фазные напряжения U_A, U_B и U_C для его поддержания путем измерения фазных токов (I_A, I_B и I_C) и угла ротора a.
Алгоритм управления крутящим моментом тока FOC считывает фазные токи двигателя BLDC (обычно I_A и I_B). Кроме того, алгоритм считывает угол a ротора с датчика положения. Фазные токи преобразуются в d-ток I_d и q-ток I_q с использованием обратного преобразования Кларка и Парка. Используя заданное значение тока I_d и измеренные токи I_q и I_d, ПИД-регуляторы для каждой оси рассчитывают соответствующие напряжения U_q и U_d, которые должны быть установлены на двигателе, чтобы поддерживать I_q=I_tar и I_d=0. Наконец, используя преобразование Парка + Кларка (или SpaceVector), алгоритм FOC устанавливает на двигателе соответствующие напряжения U_A, U_B и U_C. Измеряя фазные токи, этот алгоритм управления крутящим моментом гарантирует, что эти напряжения генерируют соответствующие токи и магнитную силу в роторе двигателя со смещением точно на 90 градусов от его постоянного магнитного поля, что гарантирует максимальный крутящий момент.
 
Для управления током пользователю необходимо настроить ПИД регуляторы I_qи I_dсоставляющих тока, а также считывать значение фазных токов с обмоток двигателя. Драйвер SimpleFOC PowerShield позволяет измерить токи I_A и I_С с помощью метода Inline Current Sense, а для настройки регуляторов использовался метод Циглера-Никольса.
Этот метод является самым простым в использовании и наиболее точным. Шунтирующие резисторы размещаются на одной линии с фазами двигателя, и ток, измеряемый на этих шунтирующих резисторах, будет током фазы двигателя независимо от состояния рабочего цикла ШИМ. Таким образом, эта реализация очень подходит для устройств Arduino из-за того, что переменный ток может быть выбран в любое время для считывания тока, а продолжительность сбора постоянного тока не так важна, как для других подходов к измерению тока. Обратной стороной этого подхода является аппаратное обеспечение: эта архитектура измерения тока требует высокоточных двунаправленных усилителей с гораздо лучшим подавлением ШИМ, чем обычные усилители нижнего или верхнего плеча. Для измерения фазных токов необходимо указать сопротивление шунтирующих резисторов и коэффициенты усиления операционных усилителей, которые внедрены в используемый драйвер. Для SImpleFOC PowerShield сопротивление шунтирующего резистора 0.001 Ом и коэффициент усиления 50.

Пины для LowSideCurrent Sense
| Params | Values | Comment |
|:-----------:|:-----------:|:--------|
| R | 0.005 | - |
| Gain | 10 | - |
| Phase A | Pin 34 | - |
| Phase B | Pin 35 | - |
| Phase C | Pin 32 | - |

## Траекторное управление приводом
Траекторное управление позволяет регулировать работу привода таким образом, чтобы разгон и торможение осуществлялись плавно. Реализация данного управление осуществлена в библиотеке <TrapezoidalPlanner.h>.
Для формирования желаемого контура скорости необходимо задать значения для построения трапеции:
+ Максимальное значение скорости υ_max, задается с помощью команды GVd, где d – желаемое значение скорости;
+ Максимальное значение ускорения a_max, задается с помощью команды GAd, где d – желаемое значение ускорения;
+ Желаемое значение угла φ_des, задается с помощью команды Gd, где d – желаемое значение угла.
Для удобства отображения и настройки работы привода использовался интерфейс взаимодействия с двигателем SimpleFOCStudio by JorgeMaker [10]. С помощью данного расширения становится гораздо удобнее снимать показания с датчиков и в процессе работы скрипта изменять настройки регулятора без перепрошивки контроллера, что значительно экономит время при настройке.
Для добавления этой библиотеки необходимо добавить файлы <TrapezoidalPlanner.h> и <TrapezoidalPlanner.cpp> в папку ..\Arduino\libraries\Simple_FOC\src
Параметры трапеции: amax = 40 рад/с^2, Vmax = 80 рад/с.


## Управление жесткостью привода
Для того, чтобы использовать привод в шагающем роботе при перемещении, необходимо добавить упругость приводу, что при контакте с поверхностью позволит избежать жесткого столкновения. 
В качестве такой упругости можно рассмотреть модель пружины с демпфером, которые описывают простейший ПД-регулятор. То есть можно добавить в контур тока ПД-регулятор угла поворота, а выходное значение с этого регулятора отправлять на вход контура управления током.
